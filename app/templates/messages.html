<html>
    <head>
        <title>Live statue status messages</title>
        <script type="text/javascript" src="//code.jquery.com/jquery-1.4.2.min.js"></script>
        <script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/1.3.6/socket.io.min.js"></script>
        <script type="text/javascript" src="//dev.hel.fi/~kotkanen/scripts/Leaflet.helsinki-tiles.min.js"></script>
        <script type="text/javascript" charset="utf-8">
            var socket;
            $(document).ready(function(){
                socket = io.connect('http://' + document.domain + ':' + location.port + '/live');
                socket.on('connect', function() {
                    socket.emit('joined', {});
                });
                socket.on('message', function(data) {
                    // console.log(data.msg);
                    $('#messages').text(data.msg.toString());
                    // animateIcon(data.msg[0], data.msg[1]);
                    animateLattice(data.msg);
                });
            });

            function animateLattice(matrix) {
                for (var i=0; i<matrix.length; i++) {
                    for (var j=0; j<matrix[i].length; j++) {
                        if (matrix[i][j]) {
                            setTimeout(animateIcon, Math.random()*1000, j, i);
                        }
                    }
                }
            }
        </script>
        <style>

            .css-icon, .default-icon {

            }

            .default_ring {
                border: 2px solid #444;
                 -webkit-border-radius: 30px;
                 height: 10px;
                 width: 10px;
                 /*-webkit-animation: pulsate 2s ease-out;
                 -webkit-animation-iteration-count: infinite;*/
            }

            .animated_ring {
                border: 2px solid #444;
                 -webkit-border-radius: 30px;
                 height: 10px;
                 width: 10px;
                -webkit-animation: pulsate 2s ease-out;*/
                -webkit-animation-iteration-count: 1;
            }

            @-webkit-keyframes pulsate {
                    /*25% {-webkit-transform: scale(1.2, 1.2); opacity: 0.9;}
                    50% {-webkit-transform: scale(1, 1); opacity: 1.0;}*/
                    5% {-webkit-transform: scale(0.5, 0.5); opacity: 1;}
                    100% {-webkit-transform: scale(3, 3); opacity: 0.1;}
            }
        </style>
    </head>
    <body>
        <h1>Live statue status messages</h1>

        <div id="infobox" style="width:100%; height:2em;">
            <div id="messages">messages here</div>
        </div>
        <div id="map" style="width:100%; height:100%;"></div>

        <script>
            // taken from http://jsfiddle.net/christianjunk/waturuoz/
            var defaultIcon = L.divIcon({
                // Specify a class name we can refer to in CSS.
                className: 'default-icon',
                html: '<div class="default_ring"></div>'
                // Set marker width and height
                ,iconSize: [22,22]
                // ,iconAnchor: [11,11]
            });
            var animatedIcon = L.divIcon({
                // Specify a class name we can refer to in CSS.
                className: 'css-icon',
                html: '<div class="animated_ring"></div>'
                // Set marker width and height
                ,iconSize: [22,22]
                // ,iconAnchor: [11,11]
            });

            var map = L.map.Helsinki("map", {crs: "tm35", center:[60.2, 25.005], zoom:9});
            var servicemapBg = L.tileLayer.Helsinki("servicemap");
            servicemapBg.addTo(map);
            map.setView([60.2,25.005], 9); //TODO fix merging init opts instead of setview

            L.markers =  [];
            for (var i=0; i<20; i++) {
                var row = [];
                for(var j=0; j<30; j++) {
                    var m = L.marker([60.140944+i*0.007,24.811389+j*0.0135], {icon: defaultIcon});
                    m.addTo(map);
                    row.push(m);
                }
                L.markers.push(row);
            }

            function animateIcon (x, y) {
                console.log(x,y);
                L.markers[y][x].setIcon(animatedIcon);
                setTimeout(function() {L.markers[y][x].setIcon(defaultIcon)}, 1000)
            };
        </script>

    </body>
</html>
